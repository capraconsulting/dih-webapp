## circle.yml
machine:
    node:
        version: 6.2.2
    environment:
        NODE_ENV: test
    services:
        - docker

dependencies:
    pre:
        - npm install -g npm
        - npm install
        - npm run selenium install
        - sudo pip install awscli
        - aws configure set default.region eu-west-1
        - aws configure set default.output json
        - eval $(aws ecr get-login --region eu-west-1)

test:
    override:
        - npm test

deployment:
    prod:
        branch: master
        commands:
            - npm run build
            - docker build -t dih-webapp .
            - docker tag dih-webapp:latest $EXTERNAL_REGISTRY:latest
            - docker push $EXTERNAL_REGISTRY:latest
            - ./deploy_task.sh:
                environment:
                    AWS_TASK_FILE: file://aws_tasks/dih-webapp-prod-task.json
                    AWS_SERVICE_NAME: dih-webapp-service
                    AWS_CLUSTER_NAME: dih-cluster
    staging:
        branch: dev
        commands:
            - npm run build
            - docker build -t dih-webapp-dev .
            - docker tag dih-webapp-dev:latest $EXTERNAL_REGISTRY-dev:latest
            - docker push $EXTERNAL_REGISTRY-dev:latest
            - ./deploy_task.sh:
                environment:
                    AWS_TASK_FILE: file://aws_tasks/dih-webapp-dev-task.json
                    AWS_SERVICE_NAME: dih-webapp-dev
                    AWS_CLUSTER_NAME: dih-cluster-dev
