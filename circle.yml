## circle.yml
machine:
    node:
        version: 6.2.2
    java:
        version: openjdk7
    environment:
        NODE_ENV: test
    services:
        - docker

general:
    branches:
        only:
          - master
          - dev

dependencies:
    pre:
        - npm install -g npm
        - npm install
        - sudo pip install awscli
        - aws configure set default.region eu-west-1
        - aws configure set default.output json
        - eval $(aws ecr get-login --region eu-west-1)

test:
    branches:
        only:
            - master
            - dev
    pre:
        - npm run dist:staging
        - docker pull $EXTERNAL_API_REGISTRY-dev:latest
        - docker run -d --net host -e PG_URL=postgres://ubuntu:@127.0.0.1:5432/circle_test $EXTERNAL_API_REGISTRY-dev:latest npm run start:test
    override:
        - npm test


deployment:
    prod:
        branch: master
        commands:
            - BUCKET=dih.capra.me npm run deploy
    staging:
        branch: dev
        commands:
            - BUCKET=dev.dih.capra.me NODE_ENV=production npm run deploy:staging
